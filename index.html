<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .container { max-width: 600px; }
        .btn-primary { background-color: #00B900; border-color: #00B900; }
        .spinner-border { display: none; }
        .upload-area { border: 2px dashed #ccc; padding: 20px; text-align: center; cursor: pointer; position: relative; }
        #preview { max-width: 100%; max-height: 200px; margin-top: 10px; }
        .upload-text { color: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <h3 class="mb-4">üìù ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</h3>
        <form id="repairForm">
            <div class="mb-3">
                <label for="displayName" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á (‡∏à‡∏≤‡∏Å LINE)</label>
                <input type="text" class="form-control" id="displayName" readonly>
            </div>

            <div class="mb-3">
                <label for="repairTopic" class="form-label">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° <span class="text-danger">*</span></label>
                <select class="form-select" id="repairTopic" required>
                    <option value="" selected disabled>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠...</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="problemDetail" class="form-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                <textarea class="form-control" id="problemDetail" rows="4"></textarea>
            </div>

            <div class="mb-3">
                 <label class="form-label">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                 <div class="upload-area" onclick="document.getElementById('fileInput').click();">
                     <p class="upload-text">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>
                     <img id="preview" src="" alt="Image preview"/>
                 </div>
                 <input type="file" id="fileInput" accept="image/*" style="display: none;">
            </div>

            <button type="submit" class="btn btn-primary w-100 d-flex align-items-center justify-content-center" disabled>
                 <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                 <span id="submit-text">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
            </button>
        </form>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // --- ‚ùó ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) ---
        const LIFF_ID = "2007717724-jqqXaNqq";            // ‚ùó ‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á "‡∏´‡∏ô‡πâ‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°"
        const GAS_URL = "https://script.google.com/macros/s/AKfycbw_MGYLYRICoM4Xekk-fiahxKFkwWFw0u3qoiwKTAL2hxK5g3iRvje1ETNPyCDv9kMo/exec";  // ‚ùó ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Apps Script
        const CLOUD_NAME = "dleizzdzk";           // ‚ùó ‡πÉ‡∏™‡πà Cloud Name ‡∏à‡∏≤‡∏Å Cloudinary
        const UPLOAD_PRESET = "m1_default";     // ‚ùó ‡πÉ‡∏™‡πà Upload Preset Name ‡∏à‡∏≤‡∏Å Cloudinary
        // ------------------------------------

        let myProfile = {};
        let imageFile = null;

        document.addEventListener('DOMContentLoaded', () => {
            liff.init({ liffId: LIFF_ID })
                .then(initializeApp)
                .catch(err => { console.error("LIFF Init Error:", err); alert("LIFF ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î") });
        });

        function initializeApp() {
            if (!liff.isLoggedIn()) { liff.login(); return; }
            liff.getProfile().then(profile => {
                myProfile = profile;
                document.getElementById('displayName').value = profile.displayName;
                document.querySelector('button[type="submit"]').disabled = false;
            });
            fetchRepairTopics();
        }

       function fetchRepairTopics() {
    fetch(`${GAS_URL}?action=get_topics`)
        .then(response => response.json())
        .then(result => {
            const topicSelect = document.getElementById('repairTopic');
            topicSelect.innerHTML = '<option value="" selected disabled>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ã‡πà‡∏≠‡∏°...</option>';

            if (result.status === 'success' && result.data) {
                result.data.forEach(topic => {
                    const option = new Option(topic, topic);
                    topicSelect.add(option);
                });
            }
        })
        .catch(err => {
            console.error("Error fetching topics:", err);
            document.getElementById('repairTopic').innerHTML = '<option value="" selected disabled>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÑ‡∏î‡πâ</option>';
        });
}
        document.getElementById('fileInput').addEventListener('change', (event) => {
    imageFile = event.target.files[0];
    const preview = document.getElementById('preview');
    if (imageFile) {
        const reader = new FileReader();
        reader.onload = e => { 
            preview.src = e.target.result;
            preview.style.display = 'block'; // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        }
        reader.readAsDataURL(imageFile);
        document.querySelector('.upload-text').style.display = 'none';
    } else {
        preview.src = '';
        preview.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏£‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ
        document.querySelector('.upload-text').style.display = 'block';
    }
});

        document.getElementById('repairForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            setLoading(true);

            let photoUrl = "";
            if (imageFile) {
                photoUrl = await uploadToCloudinary(imageFile); // <<< ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
                if (!photoUrl) {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
                    setLoading(false);
                    return;
                }
            }

            const dataToSend = {
                userId: myProfile.userId,
                displayName: myProfile.displayName,
                repairTopic: document.getElementById('repairTopic').value,
                problemDetail: document.getElementById('problemDetail').value,
                photoUrl: photoUrl
            };

            fetch(GAS_URL, {
                method: 'POST', mode: 'no-cors', body: JSON.stringify(dataToSend)
            }).then(() => {
                alert('‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                liff.closeWindow();
            }).catch(error => {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                console.error('Error:', error);
                setLoading(false);
            });
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Cloudinary
        async function uploadToCloudinary(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', UPLOAD_PRESET);
            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
                    method: 'POST',
                    body: formData
                });
                if (!response.ok) throw new Error(`Upload failed: ${response.statusText}`);
                const result = await response.json();
                return result.secure_url; // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ URL ‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
            } catch (error) {
                console.error('Cloudinary Upload Error:', error);
                return null;
            }
        }

        function setLoading(isLoading) { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ... */ }
    </script>
</body>
</html>
